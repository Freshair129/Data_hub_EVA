// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

// ───────────────────────────────────────────────────────────
// Datasource: Supports PostgreSQL (local) or Supabase (cloud)
// Set DATABASE_URL in .env.local:
//   Local:    postgresql://user:pass@localhost:5432/vschool_crm
//   Supabase: postgresql://postgres:[PASSWORD]@db.[REF].supabase.co:5432/postgres
// ───────────────────────────────────────────────────────────
datasource db {
  provider = "postgresql"
}

// ───────────────────────────────────────────────────────────
// CORE MODELS
// ───────────────────────────────────────────────────────────

model Customer {
  id            String   @id @default(cuid())
  customerId    String   @unique @map("customer_id")       // e.g. "FB-CUS-0177"
  memberId      String?  @map("member_id")                 // e.g. "MEM-2024-0036"
  status        String   @default("Active")
  
  // Profile
  firstName     String?  @map("first_name")
  lastName      String?  @map("last_name")
  nickName      String?  @map("nick_name")
  jobTitle      String?  @map("job_title")
  company       String?
  membershipTier String  @default("MEMBER") @map("membership_tier")
  lifecycleStage String  @default("Lead")   @map("lifecycle_stage")
  joinDate      DateTime? @map("join_date")
  profilePicture String? @map("profile_picture")
  
  // Contact
  email         String?
  phonePrimary  String?  @map("phone_primary")
  lineId        String?  @map("line_id")
  
  // Social
  facebookId    String?  @unique @map("facebook_id")
  facebookName  String?  @map("facebook_name")
  
  // Wallet
  walletBalance Float    @default(0) @map("wallet_balance")
  walletPoints  Int      @default(0) @map("wallet_points")
  walletCurrency String  @default("THB") @map("wallet_currency")
  
  // Intelligence (AI-generated, stored as JSON for flexibility)
  intelligence  Json?    @default("{}")
  
  // Conversation Reference
  conversationId String? @map("conversation_id")
  
  // Relations
  orders        Order[]
  timeline      TimelineEvent[]
  inventory     InventoryItem[]
  conversations Conversation[]
  tasks         Task[]
  
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt      @map("updated_at")
  
  @@map("customers")
}

model Order {
  id            String   @id @default(cuid())
  orderId       String   @unique @map("order_id")          // e.g. "ORD-177-001"
  customerId    String   @map("customer_id")
  customer      Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  
  date          DateTime
  status        String   @default("PENDING")               // PENDING, PAID, CANCELLED, REFUNDED
  totalAmount   Float    @map("total_amount")
  paidAmount    Float    @default(0) @map("paid_amount")
  
  // Items stored as JSON array for flexibility
  items         Json     @default("[]")
  
  // Relations
  transactions  Transaction[]
  
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt      @map("updated_at")
  
  @@map("orders")
}

model Transaction {
  id              String   @id @default(cuid())
  transactionId   String   @unique @map("transaction_id")  // e.g. "TRN-177-001"
  orderId         String   @map("order_id")
  order           Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  
  date            DateTime
  amount          Float
  type            String                                    // DEPOSIT, FINAL, REFUND
  method          String   @default("Transfer")             // Transfer, Cash, Card
  chatMessageId   String?  @map("chat_message_id")
  note            String?
  
  // Slip Verification (AI)
  slipImageUrl    String?  @map("slip_image_url")
  slipStatus      String?  @map("slip_status")             // VERIFIED, REJECTED, PENDING
  slipData        Json?    @map("slip_data")                // AI extraction results
  
  createdAt       DateTime @default(now()) @map("created_at")
  
  @@map("transactions")
}

model InventoryItem {
  id            String   @id @default(cuid())
  customerId    String   @map("customer_id")
  customer      Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  
  type          String                                     // learning_course, coupon, bundle
  itemId        String   @map("item_id")                   // Product reference ID
  name          String
  enrollDate    DateTime? @map("enroll_date")
  expiryDate    DateTime? @map("expiry_date")
  status        String   @default("ACTIVE")                // ACTIVE, REDEEMED, EXPIRED
  metadata      Json?    @default("{}")
  
  createdAt     DateTime @default(now()) @map("created_at")
  
  @@map("inventory_items")
}

model TimelineEvent {
  id            String   @id @default(cuid())
  eventId       String   @map("event_id")                  // e.g. "SYNC-1771192843058"
  customerId    String   @map("customer_id")
  customer      Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  
  date          DateTime
  type          String                                     // CHAT, ORDER, TOPUP, STATUS_CHANGE, REDEEM
  summary       String
  details       Json?    @default("{}")
  
  createdAt     DateTime @default(now()) @map("created_at")
  
  @@map("timeline_events")
}

// ───────────────────────────────────────────────────────────
// MESSAGING
// ───────────────────────────────────────────────────────────

model Conversation {
  id              String   @id @default(cuid())
  conversationId  String   @unique @map("conversation_id") // e.g. "t_10163654156396505"
  customerId      String?  @map("customer_id")
  customer        Customer? @relation(fields: [customerId], references: [id])
  
  channel         String   @default("facebook")            // facebook, line, web
  participantName String?  @map("participant_name")
  participantId   String?  @map("participant_id")          // PSID or LINE User ID
  assignedAgent   String?  @map("assigned_agent")
  
  lastMessageAt   DateTime? @map("last_message_at")
  unreadCount     Int      @default(0) @map("unread_count")
  
  messages        Message[]
  
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt      @map("updated_at")
  
  @@map("conversations")
}

model Message {
  id              String   @id @default(cuid())
  messageId       String   @unique @map("message_id")      // Facebook message ID
  conversationId  String   @map("conversation_id")
  conversation    Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  
  fromName        String?  @map("from_name")
  fromId          String?  @map("from_id")
  content         String?
  
  // Attachments
  hasAttachment   Boolean  @default(false) @map("has_attachment")
  attachmentType  String?  @map("attachment_type")         // image, video, file
  attachmentUrl   String?  @map("attachment_url")
  
  createdAt       DateTime @default(now()) @map("created_at")
  
  @@map("messages")
}

// ───────────────────────────────────────────────────────────
// EMPLOYEES & AUTH
// ───────────────────────────────────────────────────────────

model Employee {
  id            String   @id @default(cuid())
  employeeId    String   @unique @map("employee_id")       // e.g. "em_mgt_01"
  agentId       String?  @unique @map("agent_id")          // e.g. "BOS-01"
  
  // Profile
  firstName     String   @map("first_name")
  lastName      String   @map("last_name")
  nickName      String?  @map("nick_name")
  role          String   @default("sales")                 // admin, sales, viewer
  department    String?
  profilePicture String? @map("profile_picture")
  status        String   @default("Active")
  joinDate      DateTime? @map("join_date")
  
  // Contact
  email         String   @unique
  phonePrimary  String?  @map("phone_primary")
  lineId        String?  @map("line_id")
  
  // Auth
  passwordHash  String   @map("password_hash")
  
  // Permissions (stored as JSON for flexibility)
  permissions   Json     @default("{}")
  
  // Performance
  performance   Json?    @default("{}")
  
  // Relations
  tasks         Task[]
  
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt      @map("updated_at")
  
  @@map("employees")
}

// ───────────────────────────────────────────────────────────
// PRODUCTS & CATALOG
// ───────────────────────────────────────────────────────────

model Product {
  id            String   @id @default(cuid())
  productId     String   @unique @map("product_id")        // e.g. "TVS-JP-SUSHI-CAREER-4900"
  name          String
  description   String?
  price         Float
  basePrice     Float?   @map("base_price")
  image         String?
  category      String   @default("course")                // course, bundle, package
  
  // Duration
  duration      Int?
  durationUnit  String?  @map("duration_unit")             // hours, days
  
  // Metadata (level, instructor, equipment, etc.)
  metadata      Json?    @default("{}")
  
  isActive      Boolean  @default(true) @map("is_active")
  
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt      @map("updated_at")
  
  @@map("products")
}

// ───────────────────────────────────────────────────────────
// MARKETING & CAMPAIGNS
// ───────────────────────────────────────────────────────────

model Campaign {
  id            String   @id @default(cuid())
  campaignId    String   @unique @map("campaign_id")       // Facebook Campaign ID
  name          String
  objective     String?
  status        String   @default("ACTIVE")
  
  // Metrics (daily snapshot)
  spend         Float    @default(0)
  impressions   Int      @default(0)
  clicks        Int      @default(0)
  leads         Int      @default(0)
  purchases     Int      @default(0)
  
  // Product Mapping
  mappedProductId String? @map("mapped_product_id")
  
  // Raw data from Facebook
  rawData       Json?    @map("raw_data")
  
  startDate     DateTime? @map("start_date")
  endDate       DateTime? @map("end_date")
  
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt      @map("updated_at")
  
  @@map("campaigns")
}

// ───────────────────────────────────────────────────────────
// TASK MANAGEMENT (Phase 7)
// ───────────────────────────────────────────────────────────

model Task {
  id            String    @id @default(cuid())
  taskId        String    @unique @map("task_id")          // e.g. "TSK-001"
  
  customerId    String?   @map("customer_id")
  customer      Customer? @relation(fields: [customerId], references: [id])
  
  assigneeId    String?   @map("assignee_id")
  assignee      Employee? @relation(fields: [assigneeId], references: [id])
  
  title         String
  description   String?
  type          String    @default("FOLLOW_UP")            // FOLLOW_UP, CALL, DEMO, PAYMENT
  priority      String    @default("MEDIUM")               // LOW, MEDIUM, HIGH, URGENT
  status        String    @default("PENDING")              // PENDING, IN_PROGRESS, DONE, CANCELLED
  dueDate       DateTime? @map("due_date")
  completedAt   DateTime? @map("completed_at")
  
  // AI-generated metadata
  aiGenerated   Boolean   @default(false) @map("ai_generated")
  aiContext     Json?     @map("ai_context")
  
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt      @map("updated_at")
  
  @@map("tasks")
}

// ───────────────────────────────────────────────────────────
// AUDIT LOG
// ───────────────────────────────────────────────────────────

model AuditLog {
  id            String   @id @default(cuid())
  action        String                                     // PROCESS_STARTED, SLIP_VERIFIED, etc.
  actor         String                                     // WebhookAPI, PythonAI, Employee
  target        String?                                    // Customer ID or resource
  status        String   @default("PENDING")
  traceId       String?  @map("trace_id")
  details       Json?    @default("{}")
  
  createdAt     DateTime @default(now()) @map("created_at")
  
  @@index([action, createdAt])
  @@index([target])
  @@map("audit_logs")
}

// ───────────────────────────────────────────────────────────
// SYSTEM HEALTH & ERROR TRACKING
// ───────────────────────────────────────────────────────────

model ErrorLog {
  id          String   @id @default(cuid())
  errorId     String   @unique @map("error_id")          // e.g. "ERR-20240218-A1B2"
  timestamp   DateTime @default(now())
  severity    String   @default("ERROR")                 // INFO, WARN, ERROR, CRITICAL
  category    String   // e.g. "webhook", "worker", "payment"
  
  message     String
  stackTrace  String?  @map("stack_trace")
  context     Json?    @default("{}")                    // User ID, Request Body, etc.
  tags        String[]                                   // ["#timeout", "#facebook"]
  
  // Resolution Tracking
  status        String   @default("OPEN")                // OPEN, INVESTIGATING, RESOLVED, IGNORED
  resolutionId  String?  @map("resolution_id")
  resolution    ErrorSolution? @relation(fields: [resolutionId], references: [id])
  
  // Fix Quality (User Request)
  resolutionQuality String? @map("resolution_quality") // FULL_FIX, WORKAROUND, HARDCODED, NONE
  
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt      @map("updated_at")
  
  @@index([category, severity])
  @@index([errorId])
  @@map("error_logs")
}

model ErrorSolution {
  id            String   @id @default(cuid())
  title         String   // e.g. "Fix regex for Thai phone numbers"
  content       String   // Markdown description of the fix
  
  // Linking to provenance
  relatedErrorPattern String? @map("related_error_pattern") // Regex or error message substring to auto-suggest this solution
  
  // Linking to Changelog/Code
  gitCommitHash String?  @map("git_commit_hash")
  changelogId   String?  @map("changelog_id")          // Link to external changelog or internal note ID
  
  // Statistics
  timesApplied  Int      @default(0) @map("times_applied")
  
  // Relations
  resolvedErrors ErrorLog[]
  
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt      @map("updated_at")
  
  @@map("error_solutions")
}
